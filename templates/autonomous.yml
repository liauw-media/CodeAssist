# CodeAssist Autonomous Development Configuration
# Copy to .claude/autonomous.yml in your project

# ═══════════════════════════════════════════════════════════════════════
# LLM PROVIDERS
# Configure which LLM to use for autonomous runs
# ═══════════════════════════════════════════════════════════════════════

providers:
  # Default provider for all operations
  default: claude  # claude | ollama

  # Claude (Anthropic API)
  claude:
    # Uses ANTHROPIC_API_KEY from environment
    model: claude-sonnet-4-20250514  # or claude-opus-4-20250514

  # Ollama (local/self-hosted) - requires Ollama v0.14.0+
  # See: https://docs.ollama.com/api/anthropic-compatibility
  ollama:
    enabled: false
    base_url: http://localhost:11434  # or your Ollama server
    model: qwen3-coder  # recommended for coding tasks
    # Alternative models: glm-4.7:cloud, minimax-m2.1:cloud, codellama

  # Per-gate provider overrides (cost optimization)
  # Offload simpler tasks to Ollama, use Claude for complex ones
  gate_providers:
    # Critical gates - use Claude for accuracy
    test: claude
    security: claude
    mentor: claude

    # Build gate - fast compilation checks
    build:
      provider: ollama
      model: qwen2.5-coder:32b

    # Review gate - deep code analysis
    review:
      provider: ollama
      model: qwen3-coder

    # Architect gate - strong reasoning
    architect:
      provider: ollama
      model: qwq:32b

    # DevOps gate - CI/CD analysis
    devops:
      provider: ollama
      model: qwen2.5-coder:32b

    # UX gate - accessibility review
    ux:
      provider: ollama
      model: qwen3-coder

# ═══════════════════════════════════════════════════════════════════════

# Target score required to pass and create PR
target_score: 95

# Maximum iterations before flagging for human review
max_iterations: 15

# Pause between iterations (seconds) - prevents API abuse
iteration_delay: 5

# Quality gates configuration
# Gates are organized into parallel groups for faster execution
gates:
  # ═══════════════════════════════════════════════════════════════
  # PARALLEL GROUP 1: Required Gates (run first, in parallel)
  # ═══════════════════════════════════════════════════════════════

  test:
    weight: 25
    required: true
    auto_fix: true
    parallel_group: 1
    description: "Unit/integration tests must pass"
    thresholds:
      min_coverage: 80
      max_failures: 0
    on_fail:
      action: retry
      max_retries: 3

  security:
    weight: 25
    required: true
    auto_fix: true
    parallel_group: 1
    description: "Security audit - no critical/high vulnerabilities"
    thresholds:
      critical_vulns: 0
      high_vulns: 0
      medium_vulns: 3  # Allow up to 3 medium (creates issues)
    on_fail:
      action: retry
      max_retries: 3
    creates_issues_for:
      - medium_vulns
      - low_vulns

  build:
    weight: 15
    required: true
    auto_fix: true
    parallel_group: 1
    command: /build-fix
    description: "Project must build without errors"
    on_fail:
      action: retry
      max_retries: 5

  # ═══════════════════════════════════════════════════════════════
  # PARALLEL GROUP 2: Quality Gates (run after required pass)
  # ═══════════════════════════════════════════════════════════════

  review:
    weight: 20
    required: false
    auto_fix: true
    parallel_group: 2
    command: /review
    remediation: /cleanup
    description: "Code review - style, smells, duplication"
    thresholds:
      max_smells: 2  # Allow minor smells
      max_duplication: 5  # Percentage
    creates_issues_for:
      - unfixed_smells
      - high_complexity

  mentor:
    weight: 10
    required: false
    auto_fix: false
    parallel_group: 2
    command: /mentor
    description: "Architecture review - patterns, concerns"
    creates_issues_for:
      - architectural_concerns
      - tech_debt_recommendations
    trigger: on_first_pass  # Only run once score > 80

  ux:
    weight: 5
    required: false
    auto_fix: false
    parallel_group: 2
    command: /ux
    description: "UX review - accessibility, usability"
    applies_to:
      - frontend
      - ui
      - component
    creates_issues_for:
      - accessibility_issues
      - usability_concerns

  # ═══════════════════════════════════════════════════════════════
  # PARALLEL GROUP 3: Advisory Gates (0 weight, create issues only)
  # ═══════════════════════════════════════════════════════════════

  architect:
    weight: 0
    required: false
    auto_fix: false
    parallel_group: 3
    command: /architect
    description: "System security & performance advisor"
    creates_issues_for:
      - security_hardening
      - performance_bottlenecks
      - scalability_concerns
      - disaster_recovery
    output:
      - security_posture: "strong|adequate|weak"
      - performance_rating: "optimized|acceptable|needs_work"
      - quick_wins: list
      - roadmap: phases

  devops:
    weight: 0
    required: false
    auto_fix: false
    parallel_group: 3
    command: /devops
    description: "CI/CD and infrastructure review"
    applies_to:
      - .github/workflows
      - Dockerfile
      - docker-compose
      - terraform
      - ansible
      - k8s
      - helm
    creates_issues_for:
      - ci_cd_improvements
      - container_optimizations
      - secrets_management
      - monitoring_gaps
    output:
      - ci_cd_health: "healthy|needs_attention|broken"
      - container_health: "optimized|acceptable|needs_work|missing"
      - missing_essentials: list

# Score calculation
scoring:
  # Minimum scores per gate to contribute full points
  full_score_threshold: 0.95  # 95% of gate checks pass = full points

  # Partial scoring
  partial_scoring: true
  partial_minimum: 0.70  # Below 70% = 0 points for that gate

  # Bonus points (can exceed gate weight by 10%)
  bonus:
    enabled: true
    test_coverage_above_90: 2
    zero_code_smells: 2
    zero_security_issues: 1

# Issue creation for unresolved items
auto_issues:
  enabled: true

  templates:
    security:
      title: "[Security] {severity}: {title}"
      labels: [security, auto-generated, "{severity}"]
      body: |
        ## Security Issue

        **Severity:** {severity}
        **Location:** {file}:{line}
        **Found by:** /security gate

        ### Description
        {description}

        ### Recommendation
        {recommendation}

        ---
        *Auto-generated by CodeAssist autonomous run*
        *Parent: #{parent_issue}*

    tech_debt:
      title: "[Tech Debt] {title}"
      labels: [tech-debt, auto-generated, mentor]
      body: |
        ## Technical Debt

        **Category:** {category}
        **Impact:** {impact}
        **Found by:** /mentor gate

        ### Concern
        {description}

        ### Recommendation
        {recommendation}

        ---
        *Auto-generated by CodeAssist autonomous run*
        *Parent: #{parent_issue}*

    code_quality:
      title: "[Quality] {title}"
      labels: [code-quality, auto-generated, refactor]
      body: |
        ## Code Quality Issue

        **Type:** {type}
        **Location:** {file}:{line}
        **Found by:** /review gate

        ### Issue
        {description}

        ### Suggested Fix
        {suggestion}

        ---
        *Auto-generated by CodeAssist autonomous run*
        *Parent: #{parent_issue}*

# Human intervention
intervention:
  # Keywords in issue comments that trigger actions
  triggers:
    pause: ["@pause", "@stop", "@hold"]
    resume: ["@resume", "@continue", "@go"]
    instruction: ["@claude"]
    skip_gate: ["@skip-gate"]
    priority: ["@priority"]

  # Notify on these events
  notifications:
    on_blocked: true
    on_score_plateau: true  # Score hasn't improved in 3 iterations
    on_pr_ready: true
    on_human_needed: true

# Safety limits
safety:
  max_api_calls_per_hour: 100
  max_issues_created_per_run: 10
  max_file_changes_per_iteration: 50

  # Forbidden actions
  forbidden:
    - force_push
    - push_to_main
    - push_to_master
    - push_to_staging  # Must use PR
    - delete_branch_main
    - modify_ci_config  # Unless explicitly allowed
    - auto_merge  # PRs always need human approval

# Git workflow rules (CRITICAL - always enforced)
git_rules:
  # Branch protection
  protected_branches:
    - main
    - master
    - staging
    - production

  # PR requirements
  pr_required: true
  pr_review_required: true

  # Branch flow
  branch_flow:
    feature: staging  # Feature branches merge to staging
    staging: main     # Staging merges to main
    hotfix: main      # Hotfixes can go direct to main (with PR)

  # Commit rules
  commit_rules:
    # NEVER include AI attribution
    forbidden_patterns:
      - "Co-Authored-By: Claude"
      - "Co-Authored-By:.*anthropic"
      - "Co-Authored-By:.*openai"
      - "Generated by Claude"
      - "Generated by AI"
      - "AI-generated"

    # Required format
    format: "type: description"
    max_length: 72

    # Strip forbidden patterns automatically
    auto_strip: true

# Presets for different scenarios
presets:
  default:
    target_score: 95
    gates: all

  prototype:
    target_score: 80
    gates:
      test:
        required: true
        thresholds:
          min_coverage: 60
      security:
        required: true
      review:
        required: false
      mentor:
        required: false
      ux:
        required: false

  production:
    target_score: 98
    gates:
      test:
        thresholds:
          min_coverage: 90
      security:
        thresholds:
          medium_vulns: 0  # No medium either
      mentor:
        required: true  # Architecture review required

  frontend:
    target_score: 95
    gates:
      ux:
        required: true
        weight: 15  # Higher weight for frontend
      review:
        weight: 15

  # Cost-optimized: Use Ollama for most gates
  ollama_hybrid:
    providers:
      default: ollama
      gate_providers:
        security: claude  # Keep security on Claude for accuracy
        test: claude      # Keep test analysis on Claude
    target_score: 90  # Slightly lower threshold for local models

  # Fully local: No cloud API calls (privacy/offline mode)
  ollama_only:
    providers:
      default: ollama
      ollama:
        enabled: true
      gate_providers:
        test: ollama
        security: ollama
        build: ollama
        review: ollama
        mentor: ollama
        ux: ollama
        architect: ollama
        devops: ollama
    target_score: 85  # Lower threshold for fully local
